@model InventoryManagementPro.Models.ViewModels.ReportsVM
@using System.Text.Json

@{
    ViewData["Title"] = "Reports";
}

<div class="page-header">
    <h2 class="page-title">Reports</h2>
    <div class="page-subtitle">Generate inventory and sales reports</div>
</div>

<div class="kpi-row">
    <div class="kpi green">
        <div class="kpi-top">
            <div class="kpi-left">
                <div class="kpi-icon-lg"><i class="bi bi-cash-stack"></i></div>
                <div class="kpi-text">
                    <div class="kpi-value">$@Model.RevenueLastXDays</div>
                    <div class="kpi-sub">Revenue (@Model.RangeDays days)</div>
                </div>
            </div>
        </div>
    </div>

    <div class="kpi blue">
        <div class="kpi-top">
            <div class="kpi-left">
                <div class="kpi-icon-lg"><i class="bi bi-bag-check"></i></div>
                <div class="kpi-text">
                    <div class="kpi-value">@Model.OrdersLastXDays</div>
                    <div class="kpi-sub">Orders (@Model.RangeDays days)</div>
                </div>
            </div>
        </div>
    </div>

    <div class="kpi orange">
        <div class="kpi-top">
            <div class="kpi-left">
                <div class="kpi-icon-lg"><i class="bi bi-box-seam"></i></div>
                <div class="kpi-text">
                    <div class="kpi-value">@Model.ProductsAddedLastXDays</div>
                    <div class="kpi-sub">Products Added</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="panel">
    <div class="panel-h">
        <div>Report Filters</div>
        <div class="panel-right">
            <button form="reportForm" name="submitAction" value="export" class="btn-ghost" type="submit">
                <i class="bi bi-download"></i> Export
            </button>
        </div>
    </div>

    <div class="panel-b">
        <form id="reportForm" asp-action="Generate" method="post">
            @Html.AntiForgeryToken()

            <div class="report-filters">
                <div class="filter-item">
                    <label>Date Range</label>
                    <select name="range">
                        <option value="7" selected="@(Model.RangeDays == 7)">Last 7 days</option>
                        <option value="30" selected="@(Model.RangeDays == 30)">Last 30 days</option>
                        <option value="90" selected="@(Model.RangeDays == 90)">Last 90 days</option>
                        <option value="365" selected="@(Model.RangeDays == 365)">This Year</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label>Report Type</label>
                    <select name="type">
                        <option value="Sales" selected="@(Model.ReportType == "Sales")">Sales Report</option>
                        <option value="Inventory" selected="@(Model.ReportType == "Inventory")">Inventory Report</option>
                        <option value="LowStock" selected="@(Model.ReportType == "LowStock")">Low Stock Report</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label>Format</label>
                    <select name="format">
                        <option value="PDF" selected="@(Model.Format == "PDF")">PDF</option>
                        <option value="Excel" selected="@(Model.Format == "Excel")">Excel</option>
                    </select>
                </div>

                <div class="filter-item filter-btn">
                    <button name="submitAction" value="generate" class="btn-primary-dark" type="submit">
                        <i class="bi bi-play-fill"></i> Generate
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="panel">
    <div class="panel-h">
        <div>Monthly Revenue</div>
        <div class="panel-actions">
            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </div>
    </div>
    <div class="panel-b">
        <div style="height:240px;">
            <canvas id="reportChart"></canvas>
        </div>
    </div>
</div>

<div class="table-wrap">
    <div class="table-head table-toolbar">
        <div class="table-title">Generated Report (Preview)</div>

        <div class="table-tools">
            <form method="get" asp-action="Index" class="tool-search">
                <input type="hidden" name="range" value="@Model.RangeDays" />
                <input type="hidden" name="type" value="@Model.ReportType" />
                <input type="hidden" name="format" value="@Model.Format" />

                <i class="bi bi-search"></i>
                <input name="q" value="@Model.Q" placeholder="Search..." />
            </form>

            <button class="btn-ghost" type="button" onclick="window.print()">
                Print <i class="bi bi-printer"></i>
            </button>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width:120px;">ID</th>
                <th>Title</th>
                <th>Created</th>
                <th>Type</th>
                <th>Status</th>
                <th style="width:190px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.RecentReports != null && Model.RecentReports.Any())
            {
                foreach (var r in Model.RecentReports)
                {
                    <tr>
                        <td>#R-@r.Id</td>
                        <td>@r.Title</td>
                        <td>@r.CreatedUtc.ToLocalTime().ToString("dd MMM yyyy hh:mm tt")</td>
                        <td>@r.Type</td>
                        <td>
                            <span class="badge @(r.Status == "Ready" ? "in" : "low")">@r.Status</span>
                        </td>
                        <td class="actions-wide">
                            <a class="btn-action edit" asp-action="Details" asp-route-id="@r.Id">
                                <i class="bi bi-eye"></i> View
                            </a>
                            <a class="btn-action del" asp-action="Download" asp-route-id="@r.Id">
                                <i class="bi bi-download"></i> Download
                            </a>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="6" style="text-align:center; opacity:.7;">No reports found</td>
                </tr>
            }
        </tbody>
    </table>
</div>

<script>
    const reportLabels = @Html.Raw(JsonSerializer.Serialize(Model.Labels));
    const reportData = @Html.Raw(JsonSerializer.Serialize(Model.RevenueData));
</script>

@section Scripts {
    <script>
        Chart.defaults.color = 'rgba(233,238,246,.70)';
        Chart.defaults.borderColor = 'rgba(255,255,255,.06)';

        const ctx = document.getElementById('reportChart');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: reportLabels,
                datasets: [{
                    label: 'Revenue',
                    data: reportData,
                    borderWidth: 0,
                    backgroundColor: 'rgba(96,165,250,.35)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { color: 'rgba(233,238,246,.45)' }, grid: { color: 'rgba(255,255,255,.05)' } },
                    y: { ticks: { color: 'rgba(233,238,246,.45)' }, grid: { color: 'rgba(255,255,255,.05)' } }
                }
            }
        });
    </script>
}