@model InventoryManagementPro.Models.ViewModels.DashboardVM
@using System.Text.Json
@{
    ViewData["Title"] = "Dashboard";
}

<div class="kpi-row">
    <div class="kpi green">
        <div class="kpi-top">
            <div class="kpi-left">
                <div class="kpi-icon-lg"><i class="bi bi-lock"></i></div>
                <div class="kpi-text">
                    <div class="kpi-value">@Model.TotalProducts</div>
                    <div class="kpi-sub">Total Products</div>
                </div>
            </div>
        </div>
        <a class="kpi-bottom kpi-bottom-link" asp-controller="Products" asp-action="Index">
            <span>View Products</span>
            <i class="bi bi-chevron-right"></i>
        </a>
    </div>

    <div class="kpi orange">
        <div class="kpi-top">
            <div class="kpi-left">
                <div class="kpi-icon-lg"><i class="bi bi-currency-dollar"></i></div>
                <div class="kpi-text">
                    <div class="kpi-value">$@Model.RevenueThisMonth</div>
                    <div class="kpi-sub">This Month</div>
                </div>
            </div>
        </div>
        <a class="kpi-bottom kpi-bottom-link" asp-controller="Sales" asp-action="Index">
            <span>View Sales</span>
            <i class="bi bi-chevron-right"></i>
        </a>
    </div>

    <div class="kpi red">
        <div class="kpi-top">
            <div class="kpi-left">
                <div class="kpi-icon-lg"><i class="bi bi-exclamation-triangle"></i></div>
                <div class="kpi-text">
                    <div class="kpi-value">@Model.LowStockCount</div>
                    <div class="kpi-sub">Low Stock Alerts</div>
                </div>
            </div>
        </div>
        <a class="kpi-bottom kpi-bottom-link" asp-controller="Products" asp-action="Index">
            <span>View Alerts</span>
            <i class="bi bi-chevron-right"></i>
        </a>
    </div>

    <div class="kpi blue">
        <div class="kpi-top">
            <div class="kpi-left">
                <div class="kpi-icon-lg"><i class="bi bi-receipt"></i></div>
                <div class="kpi-text">
                    <div class="kpi-value">@Model.TotalOrders</div>
                    <div class="kpi-sub">Total Orders</div>
                </div>
            </div>
        </div>
        <a class="kpi-bottom kpi-bottom-link" asp-controller="Orders" asp-action="Index">
            <span>View Orders</span>
            <i class="bi bi-chevron-right"></i>
        </a>
    </div>
</div>

<div class="grid-2">
    <div class="panel">
        <div class="panel-h">
            <div>Stock Products</div>
        </div>

        <div class="panel-b chart-split">
            <div style="height:200px;">
                <canvas id="donutChart"></canvas>
            </div>

            <div class="chart-legend">
                <div class="legend-row"><span>In Stock</span><b>@Model.InStockCount</b></div>
                <div class="legend-row"><span>Low Stock</span><b>@Model.LowStockCount</b></div>
                <div class="legend-row"><span>Out of Stock</span><b>@Model.OutOfStockCount</b></div>
            </div>
        </div>
    </div>

    <div class="panel">
        <div class="panel-h">
            <div>Sales Overview</div>
        </div>
        <div class="panel-b">
            <div style="height:220px;">
                <canvas id="lineChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="table-wrap">
    <div class="table-head">
        <div class="table-title">Inventory List</div>
    </div>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Product</th>
                <th>Category</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>

        <tbody>
            @if (Model.RecentProducts != null && Model.RecentProducts.Any())
            {
                foreach (var p in Model.RecentProducts)
                {
                    <tr>
                        <td>@p.Id</td>
                        <td>@p.Name</td>
                        <td>@p.Category</td>
                        <td>@p.Stock</td>
                        <td>$@p.Price</td>
                        <td>
                            @{
                                var statusClass = p.Stock <= 0 ? "out"
                                : (p.Stock <= p.ReorderLevel ? "low" : "in");

                                var statusText = p.Stock <= 0 ? "Out of Stock"
                                : (p.Stock <= p.ReorderLevel ? "Low Stock" : "In Stock");
                            }
                            <span class="badge @statusClass">@statusText</span>
                        </td>
                        <td>
                            <a asp-controller="Products"
                               asp-action="Edit"
                               asp-route-id="@p.Id"
                               class="btn-action edit">
                                Edit
                            </a>

                            <form asp-controller="Products"
                                  asp-action="Delete"
                                  asp-route-id="@p.Id"
                                  method="post"
                                  style="display:inline;">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn-action del">
                                    Delete
                                </button>
                            </form>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="7" style="text-align:center; opacity:.7;">
                        No products found
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <div class="table-foot">
        <span>
            Showing @Model.RecentProducts?.Count() of @Model.RecentProducts?.Count() entries
        </span>
    </div>
</div>

<script>
    const revenueLabels = @Html.Raw(JsonSerializer.Serialize(Model.RevenueLabels));
    const revenueData   = @Html.Raw(JsonSerializer.Serialize(Model.RevenueData));
    const salesData     = @Html.Raw(JsonSerializer.Serialize(Model.SalesCounts)); 
    const stockData     = @Html.Raw(JsonSerializer.Serialize(
                new[] { Model.InStockCount, Model.LowStockCount, Model.OutOfStockCount }
        ));
</script>

@section Scripts {
    <script>
        Chart.defaults.color = 'rgba(233,238,246,.70)';
        Chart.defaults.borderColor = 'rgba(255,255,255,.06)';

        new Chart(document.getElementById('donutChart'), {
            type: 'doughnut',
            data: {
                labels: ['In Stock', 'Low Stock', 'Out of Stock'],
                datasets: [{
                    data: stockData,
                    backgroundColor: ['#34d399', '#ffb84d', '#ff5c5c'],
                    borderWidth: 0
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                cutout: '70%',
                responsive: true,
                maintainAspectRatio: false
            }
        });
        new Chart(document.getElementById('lineChart'), {
            type: 'line',
            data: {
                labels: revenueLabels,
                datasets: [
                    {
                        label: 'Sales',
                        data: salesData,
                        borderColor: '#34d399',
                        backgroundColor: 'rgba(52,211,153,.10)',
                        tension: .35,
                        fill: false,
                        pointRadius: 0,
                        borderWidth: 2
                    },
                    {
                        label: 'Revenue',
                        data: revenueData,
                        borderColor: '#60a5fa',
                        backgroundColor: 'rgba(96,165,250,.10)',
                        tension: .35,
                        fill: false,
                        pointRadius: 0,
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { color: 'rgba(255,255,255,.05)' } },
                    y: { grid: { color: 'rgba(255,255,255,.05)' } }
                }
            }
        });
    </script>
}